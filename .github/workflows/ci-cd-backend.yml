name: CI/CD - Backend

on:
  push:
    branches: [ main ]

env:
  TF_WORKING_DIR: cloud-resume-iac
  FUNCTION_SRC_DIR: zch-visitor-counter

jobs:

  terraform:
    name: Terraform Apply
    runs-on: ubuntu-latest
    env: 
      # Azure credentials
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      # Terraform variables
      TF_VAR_resource_group_name: cloud-resume-rg
      TF_VAR_location: uksouth
      TF_VAR_storage_account_name: zchresumestoragedev
      TF_VAR_cdn_endpoint_name: zchresume-cdn
      TF_VAR_cosmosdb_account_name: zchresume-cosmos
      TF_VAR_function_storage_name: zchfuncstorage
      TF_VAR_function_app_name: zchresume-api
    defaults:
      run:
        working-directory: ${{ env.TF_WORKING_DIR }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.3.0

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="resource_group_name=cloud-resume-rg" \
            -backend-config="storage_account_name=zchresumestoragedev" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=terraform.tfstate"

      - name: Terraform Plan
        run: terraform plan -out plan.tfplan

      - name: Terraform Apply
        if: github.ref == 'refs/heads/main'
        run: terraform apply -input=false -auto-approve plan.tfplan

  deploy-function:
    name: Build, Test & Deploy Function
    needs: terraform
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.FUNCTION_SRC_DIR }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run unit tests
        run: pytest --maxfail=1 --disable-warnings -q

      # No azure/login step neededâ€”publish profile handles auth
      - name: Deploy to Azure Functions
        uses: azure/functions-action@v1
        with:
          app-name: zchresume-api                   # your FUNCTION_APP_NAME
          publish-profile: ${{ secrets.FUNCTION_PUBLISH_PROFILE }}
          package: .

  e2e-tests:
    name: Run Cypress E2E
    needs: deploy-function
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Install dependencies
        run: npm ci

      - name: Run Cypress Tests
        run: |
          npx cypress run \
            --config baseUrl=https://zchresume.azureedge.net \
            --env apiUrl=https://zchresume-api.azurewebsites.net/api/visitorcounter